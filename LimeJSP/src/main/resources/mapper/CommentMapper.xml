<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.example.demo.comment.mapper.CommentMapper">
    
    <!-- 댓글 등록 -->
    <insert id="insertComment" parameterType="map">
        <selectKey keyProperty="comment_uid" resultType="long" order="BEFORE">
            SELECT comment_seq.NEXTVAL FROM DUAL
        </selectKey>

        INSERT INTO comment_tb 
             ( comment_uid				/* 댓글 번호 */
             , content					/* 댓글 내용 */
             , post_uid					/* 부모 게시글 번호 */
             , user_uid					/* 부모 작성자 번호 */
             , parent_comment_uid		/* 부모 댓글 번호 */
             , write_date				/* 작성 날짜 */
             , modify_date				/* 수정 날짜 */
             , deleteyn					/* 삭제 여부 */
             ) 
        VALUES 
             ( #{comment_uid}
             , #{content}
             , #{post_uid}
             , #{user_uid}
             , #{parent_comment_uid, jdbcType=NUMERIC}
             , SYSDATE
             , SYSDATE
             , 'N'
             )
    </insert>

    <!-- 댓글 수정 -->
    <update id="updateComment" parameterType="map">
        UPDATE comment_tb
           SET content      = #{content}		/* 내용 변경 */
             , modify_date  = SYSDATE			/* 작성 날짜 수정 */
         WHERE comment_uid = #{comment_uid}		/* 댓글 번호 */
           AND user_uid    = #{user_uid}		/* 댓글 작성자 번호 */
           AND deleteyn    = 'N'				/* 댓글 삭제 여부 */
    </update>

    <!-- 댓글 삭제 (소프트 삭제) -->
    <update id="updateCommentDeleteYn" parameterType="long">
        UPDATE comment_tb
           SET deleteyn    = 'Y'				/* 댓글 삭제 여부 */
             , modify_date = SYSDATE			/* 작성 날짜 수정 */
         WHERE comment_uid = #{commentUid}		/* 댓글 번호 */
    </update>

    <!-- 특정 댓글 조회 -->
    <select id="selectComment" parameterType="map" resultType="map">
        SELECT comment_uid						/* 댓글 번호 */
             , TO_CHAR(content) AS content		/* 댓글 내용 */
             , write_date						/* 작성 날짜 */
             , modify_date						/* 수정 날짜 */
             , deleteyn							/* 삭제 여부 */
             , parent_comment_uid				/* 부모 댓글 번호 */
             , user_uid							/* 작성자 번호 */
             , post_uid							/* 부모 게시글 번호 */
          FROM comment_tb
         WHERE comment_uid = #{comment_uid}		/* 댓글 번호 */
           AND deleteyn = 'N'					/* 삭제 여부 */
    </select>

    <!-- 계층형 댓글 목록 조회 (LEVEL 사용) -->
    <select id="selectCommentList" parameterType="map" resultType="map">
        SELECT c.comment_uid AS COMMENT_UID										/* 댓글 번호 */
             , c.parent_comment_uid AS PARENT_COMMENT_UID						/* 부모 댓글 번호 */
             , (LEVEL - 1) AS DEPTH												/* 계층 */
             , u.username AS USERNAME											/* 작성자 아이디 */
             , u.user_uid AS USER_UID											/* 작성자 번호 */
             , TO_CHAR(c.write_date, 'YYYY-MM-DD HH24:MI:SS') AS WRITE_DATE		/* 작성 날짜 */
             , c.deleteyn AS DELETEYN											/* 삭제 여부 */
             , CASE	
                  WHEN c.deleteyn = 'Y' THEN '삭제된 댓글입니다.'					/* deleteyn이 Y일때 */
                  ELSE TO_CHAR(c.content)										/* deleteyn이 N일때 */
                   END AS CONTENT												/* CASE 결과 칼럼명을 CONTENT로 지정 */
          FROM comment_tb c
          JOIN user_tb u ON c.user_uid = u.user_uid								/* user_tb와 comment_tb를 join */		
         WHERE c.post_uid = #{post_uid}
         START WITH c.parent_comment_uid IS NULL								/* 부모 댓글이 없는 댓글 */
       CONNECT BY PRIOR c.comment_uid = c.parent_comment_uid					/* PRIOR : 이전(부모) 행, 부모의 comment_uid = 자식의 parent_comment_uid*/
         ORDER SIBLINGS BY c.write_date DESC									/* 같은 부모를 가진 댓글들끼리 내림차순 정렬 */
    </select>

    <!-- 대댓글 개수 조회 -->
    <select id="selectReplyCount" parameterType="map" resultType="int">
        SELECT COUNT(*)
          FROM comment_tb
         WHERE parent_comment_uid = #{comment_uid}		/* 해당 comment_uid를 부모로 가진 자식 댓글들 */
           AND deleteyn = 'N'
    </select>

    <!-- 게시글별 댓글 수 조회 -->
    <select id="selectCommentCountByPostUid" parameterType="long" resultType="int">
        SELECT COUNT(*)
          FROM comment_tb
         WHERE post_uid = #{post_uid}
           AND deleteyn = 'N'
    </select>

    <!-- 여러 게시글의 댓글 수 일괄 조회 -->
    <select id="selectCommentCountByPostUids" parameterType="list" resultType="map">
        SELECT post_uid
             , COUNT(*) as comment_count
          FROM comment_tb
         WHERE post_uid IN
	           <foreach collection="list" item="postUid" open="(" separator="," close=")">
	           #{postUid}
	           </foreach>
           AND deleteyn = 'N'
         GROUP BY post_uid
    </select>
    
</mapper>